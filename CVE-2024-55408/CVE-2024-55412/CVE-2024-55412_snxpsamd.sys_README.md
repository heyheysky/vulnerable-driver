# Vulnerable Driver snxpsamd.sys in  SUNIX Serial Driver x64 - 10.1.0.0

---

Many vulnerability exists in driver snxpsamd.sys, which allows low-privileged users to read and write arbitary i/o port via specially crafted IOCTL requests . This can be exploited for privilege escalation, code execution under high privileges, and information disclosure. These signed drivers can also be used to bypass the Microsoft driver-signing policy to deploy malicious code.  



## version

10.1.0.0

## Vulnerability causes

snxpcamd.sys provides the functionality of read/write I/O ports, but it does not restrict the privileges of the caller, resulting in low-privileged users being able to call the driver and execute corresponding functions through DeviceIoControl.

~~~c
__int64 __fastcall sub_140010A90(__int64 a1, IRP *a2)
{
  __int64 v4; // rsi
  int v5; // r12d
  int v7; // eax
  int v8; // edi
  char v9; // bl
  __int64 v10; // rdx
  __int64 v11; // r8
  struct _IRP *v12; // r13
  unsigned int IrpCount; // eax
  unsigned int v14; // eax
  char v15; // r14
  unsigned int v16; // eax
  unsigned int v17; // eax
  unsigned int v18; // eax
  unsigned int v19; // eax
  KSYNCHRONIZE_ROUTINE *v20; // rdx
  struct _IRP *v21; // r9
  int Size_low; // r8d
  char v23; // dl
  char v24; // r13
  KSPIN_LOCK *v25; // rbx
  __int64 *v26; // r8
  KSYNCHRONIZE_ROUTINE *v27; // rdx
  unsigned int v28; // eax
  LIST_ENTRY *p_ThreadListEntry; // r13
  __int64 v30; // r9
  __int64 v31; // r8
  __int64 (__fastcall *v32)(__int64); // rax
  unsigned int v33; // r14d
  KSPIN_LOCK *v34; // r12
  KIRQL v35; // al
  KIRQL v36; // dl
  KSPIN_LOCK *v37; // rcx
  struct _IRP *MasterIrp; // r14
  unsigned int v39; // eax
  unsigned int v40; // eax
  unsigned int v41; // eax
  unsigned int v42; // eax
  unsigned int v43; // eax
  KIRQL v44; // al
  KSYNCHRONIZE_ROUTINE *v45; // rdx
  __int64 (__fastcall *v46)(); // rax
  bool v47; // zf
  struct _IRP *v48; // rdx
  void *v49; // r8
  unsigned int v50; // eax
  unsigned int v51; // eax
  unsigned int v52; // eax
  unsigned int v53; // eax
  unsigned int v54; // eax
  struct _IRP *v55; // r12
  int v56; // ecx
  int v57; // eax
  unsigned int MdlAddress; // eax
  _BYTE *v59; // r13
  char v60; // al
  char v61; // cl
  unsigned int v62; // eax
  unsigned int v63; // eax
  unsigned int v64; // eax
  unsigned int v65; // eax
  KIRQL v66; // al
  struct _IRP *v67; // r12
  int v68; // eax
  unsigned int v69; // ecx
  int MdlAddress_high; // eax
  KIRQL v71; // al
  __int64 v72; // r14
  char v73; // dl
  __int64 *p_Type; // r8
  KSYNCHRONIZE_ROUTINE *v75; // rdx
  struct _IRP *v76; // rdx
  unsigned int v77; // eax
  unsigned int v78; // eax
  unsigned int v79; // eax
  unsigned int v80; // eax
  unsigned int v81; // eax
  char Type; // dl
  unsigned __int8 *v83; // rax
  unsigned __int8 v84; // cl
  unsigned __int8 v85; // al
  int v86; // r14d
  __int64 v87; // r8
  unsigned __int8 *v88; // rax
  unsigned __int8 v89; // al
  int v90; // eax
  char v91; // al
  char v92; // al
  unsigned int v93; // ecx
  unsigned int v94; // ecx
  struct _IRP *v95; // rax
  __int64 v96; // r8
  int v97; // [rsp+30h] [rbp-D8h] BYREF
  int v98; // [rsp+34h] [rbp-D4h] BYREF
  int v99; // [rsp+38h] [rbp-D0h] BYREF
  int v100; // [rsp+3Ch] [rbp-CCh] BYREF
  int v101; // [rsp+40h] [rbp-C8h] BYREF
  __int64 SynchronizeContext[2]; // [rsp+48h] [rbp-C0h] BYREF
  __int64 v103[2]; // [rsp+58h] [rbp-B0h] BYREF
  __int64 v104[2]; // [rsp+68h] [rbp-A0h] BYREF
  __int64 v105[2]; // [rsp+78h] [rbp-90h] BYREF
  __int64 v106[2]; // [rsp+88h] [rbp-80h] BYREF
  __int64 v107[2]; // [rsp+98h] [rbp-70h] BYREF
  __int64 v108[2]; // [rsp+A8h] [rbp-60h] BYREF
  __int64 v109[10]; // [rsp+B8h] [rbp-50h] BYREF
  KIRQL Irql; // [rsp+110h] [rbp+8h] BYREF
  IRP *v111; // [rsp+118h] [rbp+10h]
  struct _IRP *CurrentStackLocation; // [rsp+120h] [rbp+18h] BYREF
  __int64 v113; // [rsp+128h] [rbp+20h] BYREF

  v111 = a2;
  v4 = *(_QWORD *)(a1 + 64);
  v113 = v4;
  v5 = 1;
  if ( *(_BYTE *)(v4 + 625) != 1 )
  {
    a2->IoStatus.Status = -1073741808;
    IofCompleteRequest(a2, 0);
    return 3221225488i64;
  }
  v7 = sub_14000457C(a2, v4);
  v8 = v7;
  v9 = 0;
  if ( !v7 )
  {
    sub_140001070(9i64, "Dispatch entry for: %x\n", a2);
    if ( (unsigned int)sub_140013CA0(a1, a2) )
      return 3221225760i64;
    CurrentStackLocation = (struct _IRP *)a2->Tail.Overlay.CurrentStackLocation;
    v12 = CurrentStackLocation;
    a2->IoStatus.Information = 0i64;
    v8 = 0;
    IrpCount = v12->AssociatedIrp.IrpCount;
    if ( IrpCount <= 0x1B006C )
    {
      if ( IrpCount == 1769580 )
      {
        if ( LODWORD(v12->MdlAddress) >= 0x14 )
        {
          a2->IoStatus.Information = 20i64;
          v106[0] = v4;
          v106[1] = (__int64)a2->AssociatedIrp.MasterIrp;
          IoAcquireCancelSpinLock(&Irql);
          KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), sub_1400105C0, v106);
LABEL_186:
          IoReleaseCancelSpinLock(Irql);
          goto LABEL_342;
        }
        goto LABEL_70;
      }
      if ( IrpCount <= 0x1B0038 )
      {
        if ( IrpCount != 1769528 )
        {
          if ( IrpCount <= 0x1B001C )
          {
            if ( IrpCount == 1769500 )
            {
              MasterIrp = a2->AssociatedIrp.MasterIrp;
              if ( v12->Flags >= 0x14 )
              {
                if ( *(_DWORD *)&MasterIrp->Type == -1
                  && *(_DWORD *)(&MasterIrp->Size + 1) == -1
                  && LODWORD(MasterIrp->MdlAddress) == -1 )
                {
                  goto LABEL_40;
                }
                v25 = (KSPIN_LOCK *)(v4 + 704);
                Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
                *(_DWORD *)(v4 + 556) = *(_DWORD *)&MasterIrp->Type;
                *(_DWORD *)(v4 + 560) = *(_DWORD *)(&MasterIrp->Size + 1);
                *(_DWORD *)(v4 + 564) = MasterIrp->MdlAddress;
                *(_DWORD *)(v4 + 568) = HIDWORD(MasterIrp->MdlAddress);
                *(_DWORD *)(v4 + 572) = MasterIrp->Flags;
                goto LABEL_240;
              }
              goto LABEL_70;
            }
            v14 = IrpCount - 1769476;
            v15 = 4;
            if ( v14 )
            {
              v16 = v14 - 4;
              if ( v16 )
              {
                v17 = v16 - 4;
                if ( v17 )
                {
                  v18 = v17 - 4;
                  if ( v18 )
                  {
                    v19 = v18 - 4;
                    if ( v19 )
                    {
                      if ( v19 == 4 )
                      {
                        if ( v12->Flags )
                        {
                          IoAcquireCancelSpinLock(&Irql);
                          if ( !*(_QWORD *)(v4 + 376) )
                          {
                            if ( !a2->Cancel )
                            {
                              *(_QWORD *)(v4 + 376) = a2;
                              ++*(_DWORD *)(v4 + 508);
                              IoReleaseCancelSpinLock(Irql);
                              sub_1400101B8((PVOID)v4);
                              return 259i64;
                            }
                            IoReleaseCancelSpinLock(Irql);
                            v8 = -1073741536;
                            goto LABEL_342;
                          }
                          v8 = -1073741811;
                          goto LABEL_186;
                        }
                        goto LABEL_70;
                      }
                      goto LABEL_40;
                    }
                    if ( *(_DWORD *)(v4 + 2072) != 1 )
                    {
                      v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
                      if ( v8 < 0 )
                        goto LABEL_342;
                    }
                    v20 = sub_1400037B0;
                  }
                  else
                  {
                    if ( *(_DWORD *)(v4 + 2072) != 1 )
                    {
                      v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
                      if ( v8 < 0 )
                        goto LABEL_342;
                    }
                    v20 = (KSYNCHRONIZE_ROUTINE *)sub_140003890;
                  }
                  goto LABEL_106;
                }
                v21 = a2->AssociatedIrp.MasterIrp;
                CurrentStackLocation = v21;
                LOBYTE(v113) = -1;
                if ( v12->Flags >= 3 )
                {
                  if ( *(_DWORD *)(v4 + 2072) != 1 )
                  {
                    v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
                    if ( v8 < 0 )
                    {
LABEL_342:
                      a2->IoStatus.Status = v8;
                      sub_140001070(9i64, "Complete Irp: %X\n", a2);
                      IofCompleteRequest(a2, 0);
                      sub_140004550(v4);
                      return (unsigned int)v8;
                    }
                    v21 = CurrentStackLocation;
                  }
                  Size_low = LOBYTE(v21->Size);
                  if ( Size_low == 5 )
                  {
                    v23 = 0;
                    LOBYTE(CurrentStackLocation) = 0;
                    LOBYTE(v113) = 31;
                  }
                  else
                  {
                    switch ( LOBYTE(v21->Size) )
                    {
                      case 6:
                        v23 = 1;
                        LOBYTE(CurrentStackLocation) = 1;
                        LOBYTE(v113) = 63;
                        break;
                      case 7:
                        v23 = 2;
                        LOBYTE(CurrentStackLocation) = 2;
                        LOBYTE(v113) = 127;
                        break;
                      case 8:
                        v23 = 3;
                        LOBYTE(CurrentStackLocation) = 3;
                        break;
                      default:
LABEL_40:
                        v8 = -1073741811;
                        goto LABEL_342;
                    }
                  }
                  *(_DWORD *)(v4 + 2516) = Size_low;
                  if ( HIBYTE(v21->Type) )
                  {
                    switch ( HIBYTE(v21->Type) )
                    {
                      case 1:
                        *(_DWORD *)(v4 + 2520) = 1;
                        v24 = 8;
                        break;
                      case 2:
                        *(_DWORD *)(v4 + 2520) = 2;
                        v24 = 24;
                        break;
                      case 3:
                        *(_DWORD *)(v4 + 2520) = 4;
                        v24 = 40;
                        break;
                      case 4:
                        *(_DWORD *)(v4 + 2520) = 3;
                        v24 = 56;
                        break;
                      default:
                        goto LABEL_40;
                    }
                  }
                  else
                  {
                    *(_DWORD *)(v4 + 2520) = 0;
                    v24 = 0;
                  }
                  if ( LOBYTE(v21->Type) )
                  {
                    if ( LOBYTE(v21->Type) == 1 )
                    {
                      if ( v23 )
                        goto LABEL_40;
                      *(_DWORD *)(v4 + 2528) = 1;
                    }
                    else
                    {
                      if ( LOBYTE(v21->Type) != 2 || !v23 )
                        goto LABEL_40;
                      *(_DWORD *)(v4 + 2528) = 2;
                    }
                  }
                  else
                  {
                    *(_DWORD *)(v4 + 2528) = 0;
                    v15 = 0;
                  }
                  v25 = (KSPIN_LOCK *)(v4 + 704);
                  Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
                  *(_BYTE *)(v4 + 624) = (unsigned __int8)CurrentStackLocation | v24 | v15 | *(_BYTE *)(v4 + 624) & 0x40;
                  *(_BYTE *)(v4 + 689) = v113;
                  v26 = (__int64 *)v4;
                  v27 = (KSYNCHRONIZE_ROUTINE *)sub_140012080;
                  goto LABEL_239;
                }
LABEL_70:
                v8 = -1073741789;
                goto LABEL_342;
              }
              if ( v12->Flags < 8 )
                goto LABEL_70;
              v28 = *(_DWORD *)a2->AssociatedIrp.MasterIrp;
              if ( v28 <= *(_DWORD *)(v4 + 464) )
                goto LABEL_342;
              p_ThreadListEntry = &v12->ThreadListEntry;
              p_ThreadListEntry->Flink = (struct _LIST_ENTRY *)ExAllocatePool2(65i64, v28, 1481461571i64);
              if ( !p_ThreadListEntry->Flink )
                goto LABEL_342;
              v30 = v4 + 336;
              v31 = v4 + 272;
              v32 = sub_1400135F0;
              return sub_140013EC4(v4, a2, v31, v30, v32);
            }
            if ( v12->Flags < 4 )
              goto LABEL_70;
            v33 = *(_DWORD *)a2->AssociatedIrp.MasterIrp;
            v8 = sub_140010348(*(unsigned int *)(v4 + 544), v33, &CurrentStackLocation);
            if ( v8 >= 0 && *(_DWORD *)(v4 + 2072) != 1 )
            {
              v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
              if ( v8 < 0 )
                goto LABEL_342;
            }
            v34 = (KSPIN_LOCK *)(v4 + 704);
            v35 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
            Irql = v35;
            if ( v8 >= 0 )
            {
              _mm_lfence();
              *(_DWORD *)(v4 + 520) = v33;
              *(_DWORD *)(v4 + 2512) = v33;
              SynchronizeContext[0] = v4;
              SynchronizeContext[1] = (__int16)CurrentStackLocation;
              KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), sub_140011F90, SynchronizeContext);
              v35 = Irql;
            }
            goto LABEL_76;
          }
          v39 = IrpCount - 1769504;
          if ( v39 )
          {
            v40 = v39 - 4;
            if ( v40 && (v41 = v40 - 4) != 0 )
            {
              v42 = v41 - 4;
              if ( !v42 )
                goto LABEL_342;
              v43 = v42 - 4;
              if ( v43 && v43 != 4 )
                goto LABEL_40;
              if ( *(_DWORD *)(v4 + 2072) != 1 )
              {
                v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
                if ( v8 < 0 )
                  goto LABEL_342;
              }
              v25 = (KSPIN_LOCK *)(v4 + 704);
              v44 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
              Irql = v44;
              if ( (((*(_DWORD *)(v4 + 588) & 0xC0) - 128) & 0xFFFFFFBF) != 0 )
              {
                v45 = sub_140002B70;
                v46 = (__int64 (__fastcall *)())sub_1400032C0;
                v47 = v12->AssociatedIrp.IrpCount == 1769520;
LABEL_99:
                if ( v47 )
                  v45 = (KSYNCHRONIZE_ROUTINE *)v46;
                KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), v45, (PVOID)v4);
                v44 = Irql;
                goto LABEL_102;
              }
            }
            else
            {
              if ( *(_DWORD *)(v4 + 2072) != 1 )
              {
                v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
                if ( v8 < 0 )
                  goto LABEL_342;
              }
              v25 = (KSPIN_LOCK *)(v4 + 704);
              v44 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
              Irql = v44;
              if ( (*(_DWORD *)(v4 + 584) & 3) != 2 )
              {
                v45 = sub_140002B00;
                v46 = sub_140003220;
                v47 = v12->AssociatedIrp.IrpCount == 1769508;
                goto LABEL_99;
              }
            }
            v8 = -1073741811;
LABEL_102:
            v36 = v44;
LABEL_241:
            v37 = v25;
            goto LABEL_78;
          }
          if ( LODWORD(v12->MdlAddress) < 0x14 )
            goto LABEL_70;
          v25 = (KSPIN_LOCK *)(v4 + 704);
          Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
          v48 = a2->AssociatedIrp.MasterIrp;
          *(_OWORD *)&v48->Type = *(_OWORD *)(v4 + 556);
          v48->Flags = *(_DWORD *)(v4 + 572);
          a2->IoStatus.Information = 20i64;
LABEL_240:
          v36 = Irql;
          goto LABEL_241;
        }
        v20 = sub_1400030D0;
LABEL_106:
        v49 = (void *)v4;
LABEL_107:
        KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), v20, v49);
        goto LABEL_342;
      }
      if ( IrpCount <= 0x1B0054 )
      {
        if ( IrpCount == 1769556 )
        {
          CurrentStackLocation = a2->AssociatedIrp.MasterIrp;
          MdlAddress = (unsigned int)v12->MdlAddress;
          if ( MdlAddress >= 3 )
          {
            v59 = CurrentStackLocation;
            sub_140006180(CurrentStackLocation, 0i64, MdlAddress);
            Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
            v60 = *(_BYTE *)(v4 + 624) & 3;
            if ( v60 )
            {
              if ( v60 == 1 )
              {
                v59[2] = 6;
              }
              else if ( v60 == 2 )
              {
                v59[2] = 7;
              }
              else
              {
                v59[2] = 8;
              }
            }
            else
            {
              v59[2] = 5;
            }
            v61 = *(_BYTE *)(v4 + 624) & 0x38;
            if ( v61 )
            {
              switch ( v61 )
              {
                case 8:
                  v59[1] = 1;
                  break;
                case 24:
                  v59[1] = 2;
                  break;
                case 40:
                  v59[1] = 3;
                  break;
                case 56:
                  v59[1] = 4;
                  break;
              }
            }
            else
            {
              v59[1] = 0;
            }
            if ( (*(_BYTE *)(v4 + 624) & 4) != 0 )
              v9 = (v59[2] != 5) + 1;
            *v59 = v9;
            a2->IoStatus.Information = 3i64;
            v36 = Irql;
            v37 = (KSPIN_LOCK *)(v4 + 704);
            goto LABEL_78;
          }
          goto LABEL_70;
        }
        v50 = IrpCount - 1769532;
        if ( !v50 )
        {
          v20 = (KSYNCHRONIZE_ROUTINE *)sub_140003120;
          goto LABEL_106;
        }
        v51 = v50 - 4;
        if ( v51 )
        {
          v52 = v51 - 4;
          if ( v52 )
          {
            v53 = v52 - 4;
            if ( v53 )
            {
              v54 = v53 - 4;
              if ( !v54 )
              {
                if ( v12->Flags < 4 )
                  goto LABEL_70;
                v56 = *(_DWORD *)a2->AssociatedIrp.MasterIrp;
                if ( !v56 || (v56 & 0xFFFFFFF0) != 0 )
                  goto LABEL_40;
                v30 = v4 + 360;
                v31 = v4 + 320;
                v32 = sub_140012FE0;
                return sub_140013EC4(v4, a2, v31, v30, v32);
              }
              if ( v54 != 4 )
                goto LABEL_40;
              v55 = a2->AssociatedIrp.MasterIrp;
              if ( LODWORD(v12->MdlAddress) < 4 )
                goto LABEL_70;
              Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
              *(_DWORD *)&v55->Type = *(_DWORD *)(v4 + 520);
              KeReleaseSpinLock((PKSPIN_LOCK)(v4 + 704), Irql);
LABEL_341:
              a2->IoStatus.Information = 4i64;
              goto LABEL_342;
            }
            if ( LODWORD(v12->MdlAddress) < 4 )
              goto LABEL_70;
            sub_140001070(9i64, "Starting or queuing wait mask irp%x\n", a2);
          }
          else
          {
            if ( v12->Flags < 4 )
              goto LABEL_70;
            if ( (*(_DWORD *)a2->AssociatedIrp.MasterIrp & 0xFFFFE000) != 0 )
              goto LABEL_40;
            sub_140001070(9i64, "Starting or queuing set mask irp %x\n", a2);
          }
          v30 = v4 + 352;
          v31 = v4 + 304;
          v32 = sub_1400143E0;
          return sub_140013EC4(v4, a2, v31, v30, v32);
        }
        if ( LODWORD(v12->MdlAddress) < 4 )
          goto LABEL_70;
        a2->IoStatus.Information = 4i64;
        v57 = *(_DWORD *)(v4 + 476);
LABEL_130:
        *(_DWORD *)a2->AssociatedIrp.MasterIrp = v57;
        goto LABEL_342;
      }
      v62 = IrpCount - 1769560;
      if ( !v62 )
      {
        if ( LODWORD(v12->MdlAddress) < 6 )
          goto LABEL_70;
        v25 = (KSPIN_LOCK *)(v4 + 704);
        Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
        v76 = a2->AssociatedIrp.MasterIrp;
        *(_DWORD *)&v76->Type = *(_DWORD *)(v4 + 576);
        *(&v76->Size + 1) = *(_WORD *)(v4 + 580);
        a2->IoStatus.Information = 6i64;
        goto LABEL_240;
      }
      v63 = v62 - 4;
      if ( v63 )
      {
        v64 = v63 - 4;
        if ( !v64 )
        {
          if ( LODWORD(v12->MdlAddress) < 0x10 )
            goto LABEL_70;
          a2->IoStatus.Information = 16i64;
          v25 = (KSPIN_LOCK *)(v4 + 704);
          Irql = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
          *(_OWORD *)&a2->AssociatedIrp.MasterIrp->Type = *(_OWORD *)(v4 + 584);
          goto LABEL_240;
        }
        v65 = v64 - 4;
        if ( !v65 )
        {
          v67 = a2->AssociatedIrp.MasterIrp;
          if ( v12->Flags < 0x10 )
            goto LABEL_70;
          if ( (*(_DWORD *)&v67->Type & 0x7FFFFF84) != 0 )
            goto LABEL_40;
          if ( (*(_DWORD *)(&v67->Size + 1) & 0x7FFFFF20) != 0 )
            goto LABEL_40;
          if ( (*(_DWORD *)&v67->Type & 3) == 3 )
            goto LABEL_40;
          v68 = (int)v67->MdlAddress;
          if ( v68 < 0 )
            goto LABEL_40;
          v69 = *(_DWORD *)(v4 + 464);
          if ( v68 > v69 )
            goto LABEL_40;
          MdlAddress_high = HIDWORD(v67->MdlAddress);
          if ( MdlAddress_high < 0 || MdlAddress_high > v69 )
            goto LABEL_40;
          v104[0] = v4;
          v104[1] = (__int64)v67;
          v71 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
          Irql = v71;
          if ( *(_BYTE *)(v4 + 690) && (*(_DWORD *)(&v67->Size + 1) & 4) != 0 )
          {
            v8 = -1073741811;
            v36 = v71;
          }
          else
          {
            KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), sub_140003290, v104);
            v36 = Irql;
          }
          v37 = (KSPIN_LOCK *)(v4 + 704);
LABEL_78:
          KeReleaseSpinLock(v37, v36);
          goto LABEL_342;
        }
        if ( v65 != 4 )
          goto LABEL_40;
        if ( LODWORD(v12->MdlAddress) < 4 )
          goto LABEL_70;
        a2->IoStatus.Information = 4i64;
        v103[0] = v4;
        v103[1] = (__int64)a2->AssociatedIrp.MasterIrp;
        v25 = (KSPIN_LOCK *)(v4 + 704);
        v66 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
        v26 = v103;
        v27 = (KSYNCHRONIZE_ROUTINE *)sub_1400106F0;
LABEL_238:
        Irql = v66;
LABEL_239:
        KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), v27, v26);
        goto LABEL_240;
      }
      v72 = (__int64)a2->AssociatedIrp.MasterIrp;
      if ( v12->Flags < 6 )
        goto LABEL_70;
      v105[0] = v4;
      v105[1] = v72;
      v34 = (KSPIN_LOCK *)(v4 + 704);
      v35 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
      Irql = v35;
      v73 = *(_BYTE *)(v4 + 690);
      if ( v73 && (v73 == *(_BYTE *)(v72 + 4) || v73 == *(_BYTE *)(v72 + 5)) )
      {
LABEL_179:
        v8 = -1073741811;
LABEL_76:
        v36 = v35;
LABEL_77:
        v37 = v34;
        goto LABEL_78;
      }
      *(_DWORD *)(v4 + 2540) = *(unsigned __int8 *)(v72 + 4);
      *(_DWORD *)(v4 + 2532) = *(unsigned __int8 *)(v72 + 5);
      p_Type = v105;
      v75 = sub_140012010;
LABEL_181:
      KeSynchronizeExecution(*(PKINTERRUPT *)(v4 + 264), v75, p_Type);
      v36 = Irql;
      goto LABEL_77;
    }
    if ( IrpCount <= 0x9C403C00 )
    {
      if ( IrpCount == -1673511936 )
      {
        LODWORD(v113) = 0;
        if ( LODWORD(v12->MdlAddress) < 4 )
          goto LABEL_70;
        if ( *(_DWORD *)(v4 + 2704) != -1 )
        {
          LOBYTE(v11) = *(_BYTE *)(v4 + 2720);
          v8 = sub_140004FB8(*(unsigned int *)(v4 + 2724), *(_QWORD *)(v4 + 2712), v11, &v113);
          if ( v8 < 0 )
            goto LABEL_342;
          *(_DWORD *)(v4 + 2728) = v113;
          a2->IoStatus.Information = 4i64;
          v57 = *(_DWORD *)(v4 + 2728);
          goto LABEL_130;
        }
      }
      else
      {
        if ( IrpCount <= 0x1B0090 )
        {
          if ( IrpCount == 1769616 )
          {
            v20 = sub_140010590;
            goto LABEL_106;
          }
          v77 = IrpCount - 1769584;
          if ( !v77 )
          {
            if ( v12->Flags < 0xC )
              goto LABEL_70;
            if ( *(int *)(&a2->AssociatedIrp.MasterIrp->Size + 1) <= 0 )
              goto LABEL_40;
            v30 = v4 + 344;
            v31 = v4 + 288;
            v32 = (__int64 (__fastcall *)(__int64))sub_140014AF0;
            return sub_140013EC4(v4, a2, v31, v30, v32);
          }
          v78 = v77 - 4;
          if ( !v78 )
          {
            if ( LODWORD(v12->MdlAddress) >= 0x40 )
            {
              sub_140010710(v4, a2->AssociatedIrp.MasterIrp);
              a2->IoStatus.Information = 64i64;
              goto LABEL_342;
            }
            goto LABEL_70;
          }
          v79 = v78 - 4;
          if ( !v79 )
          {
            if ( LODWORD(v12->MdlAddress) >= 4 )
            {
              a2->IoStatus.Information = 4i64;
              a2->IoStatus.Status = 0;
              v83 = (unsigned __int8 *)(*(_QWORD *)(v4 + 248) + 4i64);
              if ( *(_DWORD *)(v4 + 648) )
              {
                v85 = __inbyte((unsigned __int16)v83);
                v84 = v85;
              }
              else
              {
                v84 = *v83;
              }
              *(_DWORD *)a2->AssociatedIrp.MasterIrp = v84 & 3;
              goto LABEL_342;
            }
            goto LABEL_70;
          }
          v80 = v79 - 4;
          if ( v80 )
          {
            v81 = v80 - 4;
            if ( v81 )
            {
              if ( v81 != 12 )
                goto LABEL_40;
              if ( LODWORD(v12->MdlAddress) >= 0x18 )
              {
                a2->IoStatus.Information = 24i64;
                a2->IoStatus.Status = 0;
                v49 = a2;
                v20 = (KSYNCHRONIZE_ROUTINE *)sub_140010790;
                goto LABEL_107;
              }
            }
            else if ( LODWORD(v12->MdlAddress) >= 4 )
            {
              a2->IoStatus.Information = 4i64;
              *(_DWORD *)a2->AssociatedIrp.MasterIrp = 0;
              goto LABEL_342;
            }
            goto LABEL_70;
          }
          CurrentStackLocation = a2->AssociatedIrp.MasterIrp;
          if ( !v12->Flags )
            goto LABEL_70;
          v34 = (KSPIN_LOCK *)(v4 + 704);
          v35 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
          Irql = v35;
          Type = CurrentStackLocation->Type;
          if ( LOBYTE(CurrentStackLocation->Type)
            && (Type == *(_BYTE *)(v4 + 581) || Type == *(_BYTE *)(v4 + 580) || (*(_DWORD *)(v4 + 588) & 4) != 0) )
          {
            goto LABEL_179;
          }
          p_Type = (__int64 *)&a2->Type;
          v75 = (KSYNCHRONIZE_ROUTINE *)sub_140012030;
          goto LABEL_181;
        }
        switch ( IrpCount )
        {
          case 0x1B0094u:
            if ( LODWORD(v12->MdlAddress) < 4 )
              goto LABEL_70;
            a2->IoStatus.Information = 4i64;
            v109[0] = v4;
            v109[1] = (__int64)a2->AssociatedIrp.MasterIrp;
            v25 = (KSPIN_LOCK *)(v4 + 704);
            v66 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
            v26 = v109;
            v27 = sub_1400106C0;
            goto LABEL_238;
          case 0x1B0098u:
            if ( v12->Flags < 4 )
              goto LABEL_70;
            v108[0] = v4;
            v108[1] = (__int64)a2->AssociatedIrp.MasterIrp;
            if ( *(_DWORD *)(v4 + 2072) != 1 )
            {
              v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
              if ( v8 < 0 )
                goto LABEL_342;
            }
            v25 = (KSPIN_LOCK *)(v4 + 704);
            v66 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
            v26 = v108;
            v27 = (KSYNCHRONIZE_ROUTINE *)sub_1400120C0;
            goto LABEL_238;
          case 0x1B009Cu:
            if ( v12->Flags < 4 )
              goto LABEL_70;
            v107[0] = v4;
            v107[1] = (__int64)a2->AssociatedIrp.MasterIrp;
            if ( *(_DWORD *)(v4 + 2072) != 1 )
            {
              v8 = sub_14000DDB4(*(PDEVICE_OBJECT *)(v4 + 2408));
              if ( v8 < 0 )
                goto LABEL_342;
            }
            v25 = (KSPIN_LOCK *)(v4 + 704);
            v66 = KeAcquireSpinLockRaiseToDpc((PKSPIN_LOCK)(v4 + 704));
            v26 = v107;
            v27 = (KSYNCHRONIZE_ROUTINE *)sub_140012050;
            goto LABEL_238;
        }
        if ( IrpCount != 909260338 )
        {
          if ( IrpCount == -1995236985 )
            goto LABEL_342;
          goto LABEL_40;
        }
        if ( LODWORD(v12->MdlAddress) < 4 )
          goto LABEL_70;
        if ( *(_DWORD *)(v4 + 2704) != -1 )
        {
          a2->IoStatus.Information = 4i64;
          v57 = *(_DWORD *)(v4 + 2704);
          goto LABEL_130;
        }
      }
LABEL_226:
      v8 = -1073741637;
      goto LABEL_342;
    }
    if ( IrpCount <= 0x9C403C4C )
    {
      switch ( IrpCount )
      {
        case 0x9C403C4C:
          v101 = 0;
          if ( v12->Flags < 4 || LODWORD(v12->MdlAddress) < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 && *(_DWORD *)(v4 + 2700) == 0x4000 )
          {
            v8 = sub_14000574C(*(_QWORD *)(v4 + 2712), *(unsigned int *)a2->AssociatedIrp.MasterIrp, &v101);
            if ( v8 < 0 )
              goto LABEL_342;
            a2->IoStatus.Information = 4i64;
            v57 = v101;
            goto LABEL_130;
          }
          break;
        case 0x9C403C04:
          if ( v12->Flags < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 )
          {
            v86 = a2->AssociatedIrp.MasterIrp->Type;
            LOBYTE(v11) = *(_BYTE *)(v4 + 2720);
            v8 = sub_1400050BC(
                   *(unsigned int *)(v4 + 2724),
                   *(_QWORD *)(v4 + 2712),
                   v11,
                   a2->AssociatedIrp.MasterIrp->Type);
            if ( v8 >= 0 )
            {
              *(_DWORD *)(v4 + 2728) = v86;
              v88 = (unsigned __int8 *)(*(_QWORD *)(v4 + 248) + 4i64);
              if ( *(_DWORD *)(v4 + 648) )
                v89 = __inbyte((unsigned __int16)v88);
              else
                v89 = *v88;
              LOBYTE(v87) = v89;
              sub_140004970(v4, *(_QWORD *)(v4 + 248), v87);
            }
            goto LABEL_342;
          }
          break;
        case 0x9C403C08:
          v100 = 0;
          if ( LODWORD(v12->MdlAddress) < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 )
          {
            LOBYTE(v10) = *(_BYTE *)(v4 + 2720);
            v8 = sub_140004F80(*(_QWORD *)(v4 + 2712), v10, &v100);
            if ( v8 < 0 )
              goto LABEL_342;
            a2->IoStatus.Information = 4i64;
            v57 = v100;
            goto LABEL_130;
          }
          break;
        case 0x9C403C0C:
          if ( v12->Flags < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 )
          {
            LOBYTE(v11) = *(_BYTE *)(v4 + 2720);
            v8 = sub_140005068(
                   *(unsigned int *)(v4 + 2724),
                   *(_QWORD *)(v4 + 2712),
                   v11,
                   *(unsigned int *)a2->AssociatedIrp.MasterIrp);
            goto LABEL_342;
          }
          break;
        case 0x9C403C40:
          v99 = 0;
          if ( LODWORD(v12->MdlAddress) < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 && *(_DWORD *)(v4 + 2700) == 0x4000 )
          {
            v8 = sub_1400054E4(*(_QWORD *)(v4 + 2712), &v99);
            if ( v8 < 0 )
              goto LABEL_342;
            a2->IoStatus.Information = 4i64;
            v57 = v99;
            goto LABEL_130;
          }
          break;
        case 0x9C403C44:
          v98 = 0;
          if ( LODWORD(v12->MdlAddress) < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 && *(_DWORD *)(v4 + 2700) == 0x4000 )
          {
            v8 = sub_140005688(*(_QWORD *)(v4 + 2712), &v98);
            if ( v8 < 0 )
              goto LABEL_342;
            a2->IoStatus.Information = 4i64;
            v57 = v98;
            goto LABEL_130;
          }
          break;
        case 0x9C403C48:
          v97 = 0;
          if ( v12->Flags < 4 || LODWORD(v12->MdlAddress) < 4 )
            goto LABEL_70;
          if ( *(_DWORD *)(v4 + 2704) != -1 && *(_DWORD *)(v4 + 2700) == 0x4000 )
          {
            v8 = sub_14000528C(*(_QWORD *)(v4 + 2712), *(unsigned int *)a2->AssociatedIrp.MasterIrp, &v97);
            if ( v8 < 0 )
              goto LABEL_342;
            a2->IoStatus.Information = 4i64;
            v57 = v97;
            goto LABEL_130;
          }
          break;
        default:
          goto LABEL_40;
      }
      goto LABEL_226;
    }
    if ( IrpCount == -1673511840 )
    {
      if ( LODWORD(v12->MdlAddress) < 4 )
        goto LABEL_70;
      if ( *(_BYTE *)(v4 + 694) )
      {
        if ( *(_BYTE *)(v4 + 694) == 64 )
        {
          v5 = 4;
        }
        else if ( *(unsigned __int8 *)(v4 + 694) == 128 )
        {
          v5 = 8;
        }
        else if ( *(unsigned __int8 *)(v4 + 694) == 192 )
        {
          v5 = 14;
        }
      }
      *(_DWORD *)a2->AssociatedIrp.MasterIrp = v5;
      goto LABEL_341;
    }
    if ( IrpCount != -1673511836 )
    {
      if ( IrpCount != -1673511832 )
      {
        if ( IrpCount == -1673511828 )
        {
          if ( v12->Flags >= 4 )
          {
            v93 = *(_DWORD *)a2->AssociatedIrp.MasterIrp;
            if ( *(_BYTE *)(v4 + 2688) )
            {
              if ( v93 <= 1 )
                v93 = 1;
              else
                v93 = (*(_DWORD *)(v4 + 2692) * v93) >> 4;
            }
            *(_DWORD *)(v4 + 548) = v93;
            goto LABEL_342;
          }
        }
        else
        {
          if ( IrpCount != -1673511824 )
            goto LABEL_40;
          if ( v12->Flags >= 4 )
          {
            if ( *(_DWORD *)a2->AssociatedIrp.MasterIrp )
            {
              v90 = *(_DWORD *)(v4 + 2700);
              if ( v90 == 16 )
              {
                v91 = *(_BYTE *)(v4 + 2688);
                if ( *(_DWORD *)(v4 + 2692) == 64 )
                  v92 = v91 | 0x10;
                else
                  v92 = v91 | 0x20;
                *(_BYTE *)(v4 + 2688) = v92;
              }
              else if ( v90 == 32 || v90 == 4096 || v90 == 0x2000 || v90 == 0x4000 )
              {
                *(_BYTE *)(v4 + 2688) |= 0x20u;
              }
            }
            else
            {
              *(_BYTE *)(v4 + 2688) = 0;
            }
            goto LABEL_342;
          }
        }
        goto LABEL_70;
      }
      if ( LODWORD(v12->MdlAddress) < 4 )
        goto LABEL_70;
      v94 = *(_DWORD *)(v4 + 548);
      if ( *(_BYTE *)(v4 + 2688) )
      {
        if ( v94 <= 1 )
          v94 = 1;
        else
          v94 = 16 * v94 / *(_DWORD *)(v4 + 2692);
      }
      *(_DWORD *)a2->AssociatedIrp.MasterIrp = v94;
      goto LABEL_341;
    }
    if ( v12->Flags < 4 )
      goto LABEL_70;
    v95 = a2->AssociatedIrp.MasterIrp;
    if ( *(_DWORD *)&v95->Type != 1 )
    {
      switch ( *(_DWORD *)&v95->Type )
      {
        case 4:
          *(_BYTE *)(v4 + 694) = 64;
          goto LABEL_329;
        case 8:
          *(_BYTE *)(v4 + 694) = 0x80;
          goto LABEL_329;
        case 0xE:
          *(_BYTE *)(v4 + 694) = -64;
LABEL_329:
          sub_14000494C(v4, *(_QWORD *)(v4 + 248), 0i64);
          if ( *(_DWORD *)(v4 + 648) )
            __inbyte(*(_QWORD *)(v4 + 248));
          LOBYTE(v96) = *(_BYTE *)(v4 + 694) | 7;
          sub_14000494C(v4, *(_QWORD *)(v4 + 248), v96);
          goto LABEL_342;
      }
    }
    *(_BYTE *)(v4 + 694) = 0;
    goto LABEL_329;
  }
  if ( v7 != 259 )
    goto LABEL_342;
  return (unsigned int)v8;
}
~~~

### IOCTL  0x9C403C08

This IOCTL code triggers the port in operation. 

~~~c
__int64 __fastcall sub_140004F80(__int64 a1, unsigned __int8 a2, _DWORD *a3)
{
  unsigned __int8 v3; // al
  int v4; // r9d
  __int64 result; // rax

  v3 = __inbyte(a1 + 3);
  v4 = 0;
  if ( !a1 )
    return 3221225659i64;
  LOBYTE(v4) = (v3 & a2) != 0;
  result = 0i64;
  *a3 = v4;
  return result;
}
~~~

### IOCTL 0x9C403C04

This code triggers port out operation. The operation is eventually completed in function below.

```c
__int64 __fastcall sub_1400050BC(int a1, __int64 a2, char a3, unsigned int a4)
{
  unsigned __int16 v8; // r9
  unsigned __int8 v9; // al
  unsigned __int8 v10; // r8
  unsigned __int16 v11; // r10
  unsigned __int8 v12; // al
  char v13; // si
  char v14; // dl
  unsigned __int8 v16; // r8
  char v17; // dl
  unsigned __int8 v18; // si
  __int64 v19; // rdx
  __int64 v20; // rdx
  unsigned __int8 v21; // al
  unsigned __int8 v22; // r8
  unsigned __int8 v23; // al
  unsigned __int8 v24; // si
  unsigned int v25; // ebx
  __int64 v26; // rdx
  __int64 v27; // rdx

  v8 = a2 + 2;
  v9 = __inbyte(a2 + 2);
  v10 = v9;
  v11 = a2 + 3;
  v12 = __inbyte(a2 + 3);
  v13 = v12;
  v14 = 16 * a3;
  if ( !a2 )
    return 3221225659i64;
  if ( a1 )
  {
    if ( a1 == 1 )
    {
      if ( !a4 || a4 != 1 && a4 - 2 > 1 )
      {
        a4 = 3;
LABEL_21:
        v16 = a3 | v10;
        v18 = a3 | v14 | v12;
LABEL_22:
        __outbyte(v8, v16);
        v19 = v11;
        __outbyte(v11, v18);
        LOBYTE(v19) = 19;
        sub_140005C3C(a2, v19);
        LOBYTE(v20) = 20;
        sub_140005C3C(a2, v20);
        if ( a1 == 2 )
        {
          v21 = __inbyte(a2 + 13);
          v22 = v21;
          v23 = __inbyte(a2 + 12);
          v24 = v23;
          if ( a4 )
          {
            v25 = a4 - 1;
            if ( !v25 || v25 - 1 <= 1 )
            {
              v22 |= a3;
              v24 = ~a3 & v23;
            }
          }
          else
          {
            v22 |= a3;
            v24 = a3 | v23;
          }
          __outbyte(a2 + 13, v22);
          v26 = (unsigned __int16)(a2 + 12);
          __outbyte(a2 + 12, v24);
          LOBYTE(v26) = 25;
          sub_140005C3C(a2, v26);
          LOBYTE(v27) = 26;
          sub_140005C3C(a2, v27);
        }
        return 0i64;
      }
    }
    else
    {
      if ( a1 != 2 )
        return 3221225659i64;
      if ( a4 >= 2 && a4 - 2 >= 2 )
        a4 = 0;
    }
    if ( a4 )
    {
      if ( a4 == 1 )
      {
        v16 = ~a3 & v10;
        v18 = v14 | ~a3 & v12;
        goto LABEL_22;
      }
      if ( a4 != 2 )
      {
        if ( a4 != 3 )
          return 3221225659i64;
        goto LABEL_21;
      }
      v16 = a3 | v10;
      v17 = ~v14;
      v13 = a3 | v12;
    }
    else
    {
      v16 = ~a3 & v10;
      v17 = ~a3 & ~v14;
    }
    v18 = v17 & v13;
    goto LABEL_22;
  }
  return 0i64;
}
```



